<%- include('partials/header2') %>

<script>
// Show toast notification
function showToast(message, type = 'info') {
    // Create toast container if it doesn't exist
    let toast = document.getElementById('toast');
    if (!toast) {
        toast = document.createElement('div');
        toast.id = 'toast';
        document.body.appendChild(toast);
    }
    
    // Set toast content and styling
    toast.innerHTML = message;
    toast.classList.add('show');
    
    // Always use the blue-purple gradient theme
    toast.style.background = 'linear-gradient(45deg, #3b82f6, #8b5cf6)';
    
    // Add common styles
    toast.style.color = 'white';
    toast.style.borderRadius = '8px';
    toast.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.15)';
    toast.style.padding = '12px 24px';
    
    // Auto-hide the toast after 3 seconds
    setTimeout(() => {
        toast.classList.remove('show');
    }, 3000);
}

// Modal functions
function openCreatePostModal() {
    const modal = document.getElementById('createPostModal');
    modal.classList.remove('hidden');
    document.body.style.overflow = 'hidden';
}

function closeCreatePostModal() {
    const modal = document.getElementById('createPostModal');
    if (modal) {
        modal.classList.add('hidden');
        document.body.style.overflow = '';
    }
    
    // Reset form
    const form = document.getElementById('createPostForm');
    if (form) form.reset();
    
    // Clear image previews
    const previewContainer = document.getElementById('imagePreviewContainer');
    if (previewContainer && previewContainer.querySelector('div')) {
        previewContainer.querySelector('div').innerHTML = '';
        previewContainer.classList.add('hidden');
    }
    
    // Show upload placeholder
    const uploadPlaceholder = document.getElementById('imageUploadPlaceholder');
    if (uploadPlaceholder) uploadPlaceholder.classList.remove('hidden');
    
    // Hide "add more" button
    const addMoreBtn = document.getElementById('addMoreImagesBtn');
    if (addMoreBtn) addMoreBtn.classList.add('hidden');
    
    // Reset character counters
    const charCount = document.getElementById('captionCharCount');
    if (charCount) charCount.textContent = '0/2200';
    
    // Reset hidden title field
    const hiddenTitleField = document.getElementById('hiddenTitleField');
    if (hiddenTitleField) hiddenTitleField.value = '';
}
</script>

<style>
/* Custom styling for the page */
body {
    background-color: #fafafa;
}

.dark body {
    background-color: #121212;
}

/* Extra small screen breakpoint */
@media (max-width: 475px) {
    .xs\:grid-cols-3 {
        grid-template-columns: repeat(3, minmax(0, 1fr));
    }
}

/* Clamp lines for text content */
.line-clamp-6 {
    display: -webkit-box;
    -webkit-line-clamp: 6;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

/* Post menu backdrop */
.post-menu-backdrop {
    background: rgba(0, 0, 0, 0.5);
    position: fixed;
    inset: 0;
    z-index: 40;
}

/* Profile card shadow and hover effect */
.profile-card {
    transition: all 0.3s ease;
}

.profile-card:hover {
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
}

/* Add smooth transitions */
.transition-all {
    transition: all 0.3s ease;
}

/* Reduce line clamp on small screens */
@media (max-width: 640px) {
    .line-clamp-6 {
        -webkit-line-clamp: 4;
    }
}

/* Profile picture and story ring styles */
.profile-container {
    position: relative;
    width: 8rem;
    height: 8rem;
}

.story-ring {
    background: linear-gradient(45deg, #3b82f6 0%, #4f46e5 50%, #8b5cf6 100%);
    padding: 1px;
    border-radius: 50%;
}

.profile-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 9999px;
}

.add-story-button {
    position: absolute;
    bottom: 0;
    right: 0;
    background-color: #3B82F6;
    color: white;
    padding: 0.5rem;
    border-radius: 9999px;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    transition: all 0.2s;
}

.add-story-button:hover {
    background-color: #2563EB;
    transform: scale(1.1);
}

/* Toast notification */
#toast {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    background-color: #333;
    color: white;
    padding: 12px 24px;
    border-radius: 4px;
    z-index: 9999;
    opacity: 0;
    transition: opacity 0.3s ease;
}

#toast.show {
    opacity: 1;
}

/* Line clamp */
.line-clamp-6 {
    display: -webkit-box;
    -webkit-line-clamp: 6;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

/* Post menu backdrop */
.post-menu-backdrop {
    background: rgba(0, 0, 0, 0.5);
    position: fixed;
    inset: 0;
    z-index: 40;
}

@media (max-width: 640px) {
    .line-clamp-6 {
        -webkit-line-clamp: 4;
    }
}
</style>

<div class="max-w-4xl mx-auto mt-8 px-4">
    <!-- Profile Header - Instagram-like -->
    <div class="bg-white dark:bg-black rounded-lg shadow-md p-3 sm:p-4 mb-4 profile-card">
        <div class="flex flex-col md:flex-row md:items-start gap-3 md:gap-5">
            <!-- Profile Image -->
            <div class="flex justify-center md:justify-start md:shrink-0">
                <div class="relative">
                    <!-- Story Ring (if user has active story) -->
                    <div class="<%= user.hasActiveStory ? 'bg-gradient-to-tr from-yellow-400 to-fuchsia-600' : '' %> rounded-full p-[1px]">
                        <div class="bg-white dark:bg-black p-[1px]">
                            <img src="<%= user.profileImage || '/images/default-profile.png' %>" 
                                 alt="Profile" 
                                 class="w-16 h-16 md:w-20 md:h-20 rounded-full object-cover border-2 border-gray-200 dark:border-gray-800">
                        </div>
                    </div>
                    
                    <!-- Add Story Button -->
                    <button onclick="document.getElementById('storyUpload').click()"
                    class="add-story-button absolute bottom-0 right-0 bg-blue-500 text-white rounded-full w-6 h-6 flex items-center justify-center shadow-md">
                        <i class="fas fa-plus text-xs"></i>
                    </button>
                    
                    <input type="file"
                    class="hidden"
                    id="storyUpload"
                    accept="image/*,video/*"
                    onchange="handleStoryUpload(event)">
                </div>
            </div>
            
            <!-- Profile Info -->
            <div class="flex-grow">
                <!-- Username and Create Button -->
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 mb-3">
                    <div>
                        <h1 class="text-xl md:text-2xl font-bold text-gray-800 dark:text-white"><%= user.name %></h1>
                        <p class="text-gray-500 dark:text-gray-400">@<%= user.username %></p>
                    </div>
                    <div>
                        <button onclick="openCreatePostModal()" 
                                class="w-full sm:w-auto inline-flex items-center justify-center px-4 py-2 bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-md hover:from-blue-600 hover:to-purple-700 transition-all text-sm">
                            <i class="fas fa-plus-circle mr-2"></i> Create
                        </button>
                    </div>
                </div>
                
                <!-- Stats Row - Compact -->
                <div class="grid grid-cols-3 gap-1 max-w-xs mb-3">
                    <div class="text-center px-1 py-1.5 bg-gray-50 dark:bg-gray-900 rounded-lg">
                        <span class="block text-xl font-bold text-gray-900 dark:text-white"><%= user.posts ? user.posts.length : 0 %></span>
                        <span class="text-xs font-medium text-gray-500 dark:text-gray-400">posts</span>
                    </div>
                    <div class="text-center px-1 py-1.5 bg-gray-50 dark:bg-gray-900 rounded-lg">
                        <button class="w-full h-full focus:outline-none" onclick="showFollowers('followers')">
                            <span class="block text-xl font-bold text-gray-900 dark:text-white"><%= user.followers ? user.followers.length : 0 %></span>
                            <span class="text-xs font-medium text-gray-500 dark:text-gray-400">followers</span>
                        </button>
                    </div>
                    <div class="text-center px-1 py-1.5 bg-gray-50 dark:bg-gray-900 rounded-lg">
                        <button class="w-full h-full focus:outline-none" onclick="showFollowers('following')">
                            <span class="block text-xl font-bold text-gray-900 dark:text-white"><%= user.following ? user.following.length : 0 %></span>
                            <span class="text-xs font-medium text-gray-500 dark:text-gray-400">following</span>
                        </button>
                    </div>
                </div>
                
                <!-- Bio with better spacing -->
                <% if (user.bio) { %>
                <p class="text-gray-700 dark:text-gray-300 text-sm mb-2"><%= user.bio %></p>
                <% } %>
            </div>
        </div>
    </div>

    <!-- Create Post Button for Mobile -->
    <div class="md:hidden fixed bottom-4 right-4 z-10">
        <button onclick="openCreatePostModal()" 
                class="p-4 bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-full shadow-lg hover:shadow-xl transition transform hover:scale-105">
            <i class="fas fa-plus text-xl"></i>
        </button>
    </div>

    <!-- Posts Section - Instagram Grid Style -->
    <div class="bg-white dark:bg-black rounded-lg shadow-md p-4 sm:p-6">
        <h2 class="text-xl font-semibold text-gray-800 dark:text-white mb-6 flex items-center">
            <i class="fas fa-th mr-2"></i> Posts
        </h2>
        
        <% if (user.posts.length === 0) { %>
            <div class="flex flex-col items-center justify-center py-12 text-center">
                <div class="text-5xl text-gray-300 dark:text-gray-600 mb-4">
                    <i class="fas fa-camera"></i>
                </div>
                <p class="text-gray-500 dark:text-gray-400 mb-2">No posts yet</p>
                <p class="text-sm text-gray-400 dark:text-gray-500">When you share photos, they'll appear here.</p>
            </div>
        <% } else { %>
            <div class="grid grid-cols-2 md:grid-cols-3 gap-2 md:gap-4">
                <% user.posts.forEach(post => { %>
                    <div class="group relative aspect-square overflow-hidden rounded-md block transform transition hover:scale-[0.98]" data-post-id="<%= post._id %>">
                        <a href="/post/<%= post._id %>" class="block w-full h-full">
                            <% if (post.images && post.images.length > 0) { %>
                                <img src="<%= post.images[0].url %>" 
                                    alt="Post thumbnail"
                                    class="w-full h-full object-cover">
                                    
                                <% if (post.images.length > 1) { %>
                                    <div class="absolute top-2 right-2 text-white">
                                        <i class="fas fa-clone"></i>
                                    </div>
                                <% } %>
                            <% } else { %>
                                <!-- Show text content for posts without images -->
                                <div class="w-full h-full flex items-center justify-center bg-gradient-to-br from-blue-500 to-purple-600 p-4 text-white overflow-hidden">
                                    <p class="text-center text-sm md:text-base line-clamp-6 font-medium">
                                        <%= post.content || post.title || 'No content' %>
                                    </p>
                                </div>
                            <% } %>
                            
                            <!-- Post Overlay on Hover -->
                            <div class="absolute inset-0 bg-black bg-opacity-50 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center space-x-6 text-white">
                                <div class="flex items-center">
                                    <i class="fas fa-heart mr-2"></i>
                                    <span><%= post.likes ? post.likes.length : 0 %></span>
                                </div>
                                <div class="flex items-center">
                                    <i class="fas fa-comment mr-2"></i>
                                    <span><%= post.comments ? post.comments.length : 0 %></span>
                                </div>
                            </div>
                        </a>
                        
                        <!-- Three dots menu trigger -->
                        <div class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity">
                            <button class="w-8 h-8 rounded-full bg-black bg-opacity-50 text-white flex items-center justify-center hover:bg-opacity-70 transition" 
                                   onclick="event.preventDefault(); showPostMenu(event, '<%= post._id %>')">
                                <i class="fas fa-ellipsis-h"></i>
                            </button>
                        </div>
                    </div>
                <% }) %>
            </div>
        <% } %>
    </div>
</div>

<!-- Create Post Modal -->
<div id="createPostModal" class="hidden fixed inset-0 bg-black bg-opacity-80 z-50 flex items-center justify-center backdrop-blur-sm">
    <div class="bg-white dark:bg-gray-900 rounded-xl max-w-2xl w-full md:w-4/5 lg:w-3/4 mx-4 shadow-xl overflow-hidden transform transition-all">
        <!-- Header -->
        <div class="px-4 py-3 border-b border-gray-200 dark:border-gray-800 flex justify-between items-center">
            <button onclick="closeCreatePostModal()" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 p-1">
                <i class="fas fa-arrow-left"></i>
            </button>
            <h2 class="text-base font-semibold text-gray-800 dark:text-white">New Post</h2>
            <button type="submit" form="createPostForm" id="submitPostBtn" class="text-blue-500 font-semibold hover:text-blue-600 dark:text-blue-400 dark:hover:text-blue-300 text-sm">
                Share
            </button>
        </div>

        <form id="createPostForm" class="flex flex-col md:flex-row h-full max-h-[80vh]">
            <!-- Image Upload and Preview Section - Takes 60% width on larger screens -->
            <div class="flex-grow md:w-3/5 h-[50vh] md:h-[70vh] md:max-h-[80vh]">
                <!-- Image Preview Container -->
                <div id="imagePreviewContainer" class="hidden h-full">
                    <div class="bg-gray-50 dark:bg-gray-800 relative h-full w-full overflow-hidden">
                        <!-- Instagram-like grid layout -->
                        <div class="grid grid-cols-1 gap-1 h-full w-full" id="previewGrid">
                            <!-- Image previews will be added here -->
                        </div>
                        
                        <!-- Add more images button - shows when at least one image is selected -->
                        <button type="button" class="absolute bottom-3 right-3 bg-black bg-opacity-70 text-white rounded-full p-3 hidden hover:bg-opacity-80 transition-all" id="addMoreImagesBtn">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Image Upload Placeholder - shows when no images are selected -->
                <div id="imageUploadPlaceholder" class="h-full flex flex-col items-center justify-center bg-gray-50 dark:bg-gray-800 border-0">
                    <i class="fas fa-images text-4xl text-gray-400 dark:text-gray-600 mb-3"></i>
                    <p class="text-gray-500 dark:text-gray-400 text-sm font-medium mb-2">Drag photos here</p>
                    <label class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition cursor-pointer text-sm font-medium">
                        Select from computer
                        <input type="file" id="imageInput" name="processedImages" multiple accept="image/*" class="hidden" onchange="handleImageSelect(event)">
                    </label>
                </div>
            </div>

            <!-- Post Details Section - Takes 40% width on larger screens -->
            <div class="border-t md:border-t-0 md:border-l border-gray-200 dark:border-gray-800 p-4 md:p-6 md:w-2/5">
                <!-- User Info -->
                <div class="flex items-center mb-4">
                    <img src="<%= user.profileImage %>" alt="<%= user.name %>" class="w-8 h-8 rounded-full object-cover">
                    <div class="ml-2">
                        <p class="font-semibold text-sm text-gray-800 dark:text-white"><%= user.username %></p>
                    </div>
                </div>
                
                <!-- Hidden title field to satisfy server requirements -->
                <input type="hidden" name="title" id="hiddenTitleField">
                
                <!-- Caption Input with character count -->
                <div class="relative">
                    <textarea name="content" 
                              placeholder="Write a caption..."
                              maxlength="2200"
                              class="w-full px-3 py-2 bg-transparent border-0 focus:ring-0 focus:border-gray-300 dark:text-white resize-none text-sm"
                              rows="5"
                              required></textarea>
                    <div class="absolute right-2 bottom-2 text-xs text-gray-400 dark:text-gray-600" id="captionCharCount">0/2200</div>
                </div>
                
                <!-- Emoji Picker Button -->
                <div class="flex justify-end mt-2">
                    <button type="button" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                        <i class="far fa-smile text-xl"></i>
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Post Options Menu -->
<div id="postOptionsMenu" class="fixed hidden bg-white dark:bg-gray-900 rounded-lg shadow-xl z-50 overflow-hidden w-48">
    <ul class="divide-y divide-gray-100 dark:divide-gray-800">
        <li>
            <a href="#" id="editPostOption" class="px-4 py-3 flex items-center text-gray-800 dark:text-white hover:bg-gray-100 dark:hover:bg-gray-800 transition">
                <i class="fas fa-edit mr-3 text-blue-500"></i> Edit
            </a>
        </li>
        <li>
            <button id="deletePostOption" onclick="deletePostClicked()" class="w-full px-4 py-3 flex items-center text-red-600 dark:text-red-400 hover:bg-gray-100 dark:hover:bg-gray-800 transition">
                <i class="fas fa-trash mr-3"></i> Delete
            </button>
        </li>
    </ul>
</div>

<!-- Other modals remain the same -->
<!-- Image Cropper Modal -->
<div id="cropperModal" class="hidden fixed inset-0 bg-black bg-opacity-75 z-50 flex items-center justify-center">
    <div class="bg-white dark:bg-gray-900 rounded-lg max-w-2xl w-full mx-4 p-4">
        <div class="mb-4 flex justify-between items-center">
            <h3 class="text-lg font-semibold text-gray-800 dark:text-white">Crop Image</h3>
            <button onclick="closeCropperModal()" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="relative">
            <img id="cropperImage" src="" alt="Image to crop">
        </div>
        <div class="mt-4 flex justify-end space-x-2">
            <button onclick="closeCropperModal()" class="px-4 py-2 border rounded-lg text-gray-800 dark:text-white dark:border-gray-700">
                Cancel
            </button>
            <button onclick="cropImage()" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                Crop
            </button>
        </div>
    </div>
</div>

<!-- Story Upload Preview Modal -->
<div id="storyPreviewModal" class="hidden fixed inset-0 bg-black bg-opacity-75 z-50 flex items-center justify-center">
    <div class="bg-white dark:bg-gray-900 rounded-lg max-w-lg w-full mx-4">
        <div class="p-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
            <h3 class="text-lg font-semibold text-gray-800 dark:text-white">Preview Story</h3>
            <button onclick="closeStoryPreview()" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="p-4">
            <div class="relative aspect-[9/16] bg-black rounded-lg overflow-hidden">
                <!-- Preview container -->
                <div id="storyPreviewContainer" class="w-full h-full"></div>
            </div>
            <div class="mt-4 flex justify-between space-x-2">
                <!-- Delete Story button (only visible when editing existing story) -->
                <div id="storyDeleteButtonContainer" class="hidden">
                    <button onclick="deleteStory()" 
                    class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors">
                        Delete Story
                    </button>
                </div>
                
                <div class="flex space-x-2 ml-auto">
                    <button onclick="closeStoryPreview()" 
                    class="px-4 py-2 text-gray-600 dark:text-gray-300 hover:text-gray-800 dark:hover:text-gray-100">
                        Cancel
                    </button>
                    <button onclick="uploadStory()" 
                    class="px-4 py-2 bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-lg hover:from-blue-600 hover:to-purple-700">
                        Share Story
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteConfirmModal" class="hidden fixed inset-0 bg-black bg-opacity-75 z-[9999] flex items-center justify-center">
    <div class="bg-white dark:bg-gray-900 rounded-lg w-full max-w-md mx-4 p-6">
        <h3 class="text-xl font-semibold mb-4 text-gray-800 dark:text-white">Delete Post</h3>
        <p class="mb-6 text-gray-600 dark:text-gray-300">Are you sure you want to delete this post? This action cannot be undone.</p>
        <div class="flex justify-end space-x-3">
            <button onclick="closeDeleteConfirmModal()" class="px-4 py-2 bg-gray-200 dark:bg-gray-700 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors text-gray-800 dark:text-white">
                Cancel
            </button>
            <button onclick="confirmDeletePost()" id="confirmDeleteBtn" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors">
                Delete
            </button>
        </div>
    </div>
</div>

<!-- Add Swiper JS for image carousel (if needed) -->
<link rel="stylesheet" href="https://unpkg.com/swiper/swiper-bundle.min.css" />
<script src="https://unpkg.com/swiper/swiper-bundle.min.js"></script>

<!-- Add these scripts -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css">

<script>
// Track the currently selected post
let currentPostId = null;
let cropper = null;
let storyFile = null;
let processedImages = [];

document.addEventListener('DOMContentLoaded', function() {
    // Set up event listeners for post creation
    if (document.getElementById('createPostForm')) {
        document.getElementById('createPostForm').addEventListener('submit', handlePostSubmit);
    }
    
    // Set up event listeners for post deletion
    // Note: We're now using direct onclick handlers instead of this event listener approach
    // if (document.getElementById('confirmDeleteBtn')) {
    //     document.getElementById('confirmDeleteBtn').addEventListener('click', confirmDeletePost);
    // }

    // Add drag and drop functionality for images
    const dropZone = document.getElementById('imageUploadPlaceholder');
    
    if (dropZone) {
        // Prevent default drag behaviors
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, preventDefaults, false);
            document.body.addEventListener(eventName, preventDefaults, false);
        });
        
        // Highlight drop zone when item is dragged over it
        ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.addEventListener(eventName, highlight, false);
        });
        
        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, unhighlight, false);
        });
        
        // Handle dropped files
        dropZone.addEventListener('drop', handleDrop, false);
    }
});

// Function to show post options menu
function showPostMenu(event, postId) {
    event.preventDefault();
    event.stopPropagation();
    
    // Get elements
    const menu = document.getElementById('postOptionsMenu');
    const editOption = document.getElementById('editPostOption');
    const deleteOption = document.getElementById('deletePostOption');
    
    // Set current post ID and update edit link
    currentPostId = postId;
    if (editOption) {
        editOption.href = '/edit/' + postId;
    }
    
    // Position the menu near the button that was clicked
    const buttonRect = event.currentTarget.getBoundingClientRect();
    const menuWidth = 192; // w-48 = 12rem = 192px
    
    // Calculate position (try to keep it within viewport)
    const leftPosition = Math.min(
        buttonRect.left,
        window.innerWidth - menuWidth - 10
    );
    
    menu.style.left = `${leftPosition}px`;
    menu.style.top = `${buttonRect.bottom + 5}px`;
    
    // Add a backdrop that will close the menu when clicked
    const backdrop = document.createElement('div');
    backdrop.className = 'post-menu-backdrop';
    backdrop.id = 'menuBackdrop';
    backdrop.addEventListener('click', closePostMenu);
    document.body.appendChild(backdrop);
    
    // Show the menu with animation
    menu.style.opacity = '0';
    menu.style.transform = 'translateY(-10px)';
    menu.style.transition = 'opacity 0.2s ease, transform 0.2s ease';
    menu.classList.remove('hidden');
    
    // Trigger animation
    setTimeout(() => {
        menu.style.opacity = '1';
        menu.style.transform = 'translateY(0)';
    }, 10);
    
    // Set up event handlers for menu options
    if (deleteOption) {
        deleteOption.onclick = function(e) {
            e.preventDefault();
            closePostMenu();
            showDeleteConfirmation(postId);
        };
    }
}

// Function to close post menu
function closePostMenu() {
    const menu = document.getElementById('postOptionsMenu');
    const backdrop = document.getElementById('menuBackdrop');
    
    // Hide with animation
    menu.style.opacity = '0';
    menu.style.transform = 'translateY(-10px)';
    
    // Remove after animation completes
    setTimeout(() => {
        menu.classList.add('hidden');
        if (backdrop) {
            document.body.removeChild(backdrop);
        }
    }, 200);
}

// Handle post form submission
async function handlePostSubmit(e) {
    console.log('Form submission started');
    e.preventDefault();
    e.stopPropagation();
    
    // Get form data
    const form = e.target;
    console.log('Form element:', form.id);
    
    // Prevent multiple submissions
    const submitBtn = document.getElementById('submitPostBtn');
    if (submitBtn.disabled) {
        console.log('Preventing duplicate submission - button already disabled');
        return;
    }
    
    // Store original button text and disable the button
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<span class="inline-block animate-pulse">Sharing...</span>';
    submitBtn.disabled = true;
    submitBtn.classList.add('opacity-70');
    console.log('Submit button disabled to prevent duplicate submission');
    
    // Check if there are images selected
    const imageInput = document.getElementById('imageInput');
    const files = imageInput.files;
    
    console.log('Selected files:', files ? files.length : 0);
    
    if (!files || files.length === 0) {
        console.log('No files selected');
        showToast('Please add at least one image to your post', 'warning');
        return;
    }
    
    // Create a new FormData instance
    const formData = new FormData();
    
    // Add the caption content
    const contentField = form.querySelector('textarea[name="content"]');
    const titleField = document.getElementById('hiddenTitleField');
    
    if (contentField) {
        formData.append('content', contentField.value);
        console.log('Added content to form data:', contentField.value.substring(0, 30) + '...');
    }
    
    // Add the title from hidden field
    if (titleField && titleField.value) {
        formData.append('title', titleField.value);
        console.log('Added title to form data:', titleField.value);
    } else if (contentField && contentField.value) {
        // If no title but we have content, use first line of content as title
        const titleText = contentField.value.trim().split('\n')[0].substring(0, 50);
        formData.append('title', titleText);
        console.log('Added auto-generated title to form data:', titleText);
    }
    
    // Append image files to form data
    Array.from(files).forEach((file, index) => {
        // Rename files for better organization on server
        const newFile = new File([file], `image-${index}.${file.name.split('.').pop()}`, {
            type: file.type
        });
        formData.append('processedImages', newFile);
        console.log(`Added image ${index+1} (${file.name}) to form data`);
    });
    
    // Clone the form and replace it to prevent duplicate submissions
    console.log('Cloning form to prevent duplicate submissions');
    const oldForm = form;
    const newForm = oldForm.cloneNode(true);
    oldForm.parentNode.replaceChild(newForm, oldForm);
    
    // Reattach the event listener to the new form
    newForm.addEventListener('submit', handlePostSubmit);
    console.log('Reattached event listener to new form');

    try {
        console.log('Sending POST request to /post endpoint');
        const response = await fetch('/post', {
            method: 'POST',
            body: formData
        });
        
        console.log('Response received:', response.status);
        
        if (response.ok) {
            // Parse the JSON response
            const data = await response.json();
            console.log('Success response:', data);
            showToast(data.message || 'Post shared successfully!', 'success');
            
            // Force close the modal immediately
            const modal = document.getElementById('createPostModal');
            modal.classList.add('hidden');
            document.body.style.overflow = '';
            console.log('Modal forcefully closed');
            
            // Redirect to profile page after a short delay
            console.log('Will redirect to profile page in 1 second');
            setTimeout(() => {
                console.log('Redirecting now...');
                window.location.href = '/profile';
            }, 1000);
        } else {
            console.error('Error response:', response.status);
            let errorMsg = 'Could not create post';
            
            try {
                const errorData = await response.json();
                console.error('Error data:', errorData);
                errorMsg = errorData.message || errorData.error || errorMsg;
            } catch (e) {
                console.error('Could not parse error response as JSON:', e);
                // Try to read as text instead
                try {
                    const errorText = await response.text();
                    console.error('Error text:', errorText);
                    errorMsg = errorText || errorMsg;
                } catch (textError) {
                    console.error('Could not read error response as text:', textError);
                }
            }
            
            showToast('Error: ' + errorMsg, 'error');
        }
    } catch (error) {
        console.error('Network error creating post:', error);
        showToast('Network error. Please try again.', 'error');
    } finally {
        console.log('Resetting button state');
        // Reset button state
        const submitBtn = document.getElementById('submitPostBtn');
        if (submitBtn) {
            submitBtn.innerHTML = originalText || 'Share';
            submitBtn.disabled = false;
            submitBtn.classList.remove('opacity-70');
        }
    }
}

// Function to remove image from previews (if needed)
function removeImage(index) {
    // This function could be implemented if needed for image removal
    // For now the upload refreshes all images
}

// Handle image selection
function handleImageSelect(event) {
    const files = event.target.files;
    if (!files || files.length === 0) return;
    
    const previewContainer = document.getElementById('imagePreviewContainer');
    const previewGrid = document.getElementById('previewGrid');
    const uploadPlaceholder = document.getElementById('imageUploadPlaceholder');
    const addMoreBtn = document.getElementById('addMoreImagesBtn');
    
    // Clear previous previews
    previewGrid.innerHTML = '';
    
    // Show preview container and hide placeholder
    previewContainer.classList.remove('hidden');
    uploadPlaceholder.classList.add('hidden');
    
    // Show add more button after at least one image is selected
    if (files.length > 0) {
        addMoreBtn.classList.remove('hidden');
    }
    
    // Adjust grid columns based on number of files
    if (files.length === 1) {
        previewGrid.className = 'grid grid-cols-1 h-full w-full';
    } else if (files.length === 2) {
        previewGrid.className = 'grid grid-cols-2 h-full w-full gap-1';
    } else if (files.length === 3) {
        previewGrid.className = 'grid grid-cols-2 h-full w-full gap-1';
    } else if (files.length === 4) {
        previewGrid.className = 'grid grid-cols-2 h-full w-full gap-1';
    } else {
        previewGrid.className = 'grid grid-cols-3 h-full w-full gap-1';
    }
    
    // Create preview for each file
    Array.from(files).forEach((file, index) => {
        const reader = new FileReader();
        
        reader.onload = function(e) {
            const previewItem = document.createElement('div');
            
            // Create Instagram-like styling based on position
            if (files.length === 1) {
                previewItem.className = 'relative w-full h-full';
            } else if (files.length === 2) {
                previewItem.className = 'relative aspect-square';
            } else if (files.length === 3 && index === 0) {
                previewItem.className = 'relative aspect-square col-span-2 row-span-2';
                previewGrid.className = 'grid grid-cols-2 grid-rows-2 h-full w-full gap-1';
            } else if (files.length === 4) {
                previewItem.className = 'relative aspect-square';
            } else {
                previewItem.className = 'relative aspect-square';
            }
            
            const img = document.createElement('img');
            img.src = e.target.result;
            img.className = 'w-full h-full object-cover';
            
            previewItem.appendChild(img);
            previewGrid.appendChild(previewItem);
        }
        
        reader.readAsDataURL(file);
    });
    
    // Update the form's submit button state
    updateSubmitButtonState();
}

// Add event listeners for character counts
document.addEventListener('DOMContentLoaded', function() {
    const captionInput = document.querySelector('textarea[name="content"]');
    const captionCharCount = document.getElementById('captionCharCount');
    const hiddenTitleField = document.getElementById('hiddenTitleField');
    
    captionInput.addEventListener('input', function() {
        captionCharCount.textContent = `${this.value.length}/2200`;
        
        // Auto-populate the hidden title field with the first 50 chars of caption
        if (this.value.trim()) {
            const titleText = this.value.trim().split('\n')[0].substring(0, 50);
            hiddenTitleField.value = titleText;
        } else {
            hiddenTitleField.value = '';
        }
        
        updateSubmitButtonState();
    });
    
    // Handle click on add more images button
    document.getElementById('addMoreImagesBtn').addEventListener('click', function() {
        document.getElementById('imageInput').click();
    });
});

// Function to update submit button state
function updateSubmitButtonState() {
    const captionInput = document.querySelector('textarea[name="content"]');
    const imageInput = document.getElementById('imageInput');
    const submitBtn = document.getElementById('submitPostBtn');
    
    const hasCaption = captionInput.value.trim().length > 0;
    const hasImages = imageInput.files && imageInput.files.length > 0;
    
    // Populate hidden title field if not already done
    if (hasCaption) {
        const hiddenTitleField = document.getElementById('hiddenTitleField');
        if (!hiddenTitleField.value) {
            const titleText = captionInput.value.trim().split('\n')[0].substring(0, 50);
            hiddenTitleField.value = titleText;
        }
    }
    
    submitBtn.disabled = !(hasCaption && hasImages);
    submitBtn.classList.toggle('opacity-50', !(hasCaption && hasImages));
}

// Handle story upload
function handleStoryUpload(event) {
    const file = event.target.files[0];
    
    if (!file) return;
    
    if (!file.type.startsWith('image/') && !file.type.startsWith('video/')) {
        showToast('Please select an image or video file', 'warning');
        return;
    }

    storyFile = file;
    
    // Show preview
    const previewContainer = document.getElementById('storyPreviewContainer');

    if (file.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = function(e) {
            previewContainer.innerHTML = `<img src="${e.target.result}" class="w-full h-full object-cover">`;
            document.getElementById('storyPreviewModal').classList.remove('hidden');
            
            // Check if user has an active story and show delete button
            const hasActiveStory = document.querySelector('.bg-gradient-to-tr.from-yellow-400.to-fuchsia-600');
            if (hasActiveStory) {
                document.getElementById('storyDeleteButtonContainer').classList.remove('hidden');
            }
        };
        reader.readAsDataURL(file);
    } else if (file.type.startsWith('video/')) {
        const reader = new FileReader();
        reader.onload = function(e) {
            previewContainer.innerHTML = `
                <video src="${e.target.result}" class="w-full h-full object-cover" autoplay muted loop></video>
            `;
            document.getElementById('storyPreviewModal').classList.remove('hidden');
            
            // Check if user has an active story and show delete button
            const hasActiveStory = document.querySelector('.bg-gradient-to-tr.from-yellow-400.to-fuchsia-600');
            if (hasActiveStory) {
                document.getElementById('storyDeleteButtonContainer').classList.remove('hidden');
            }
        };
        reader.readAsDataURL(file);
    }
}

// Upload story
async function uploadStory() {
    if (!storyFile) {
        showToast('Please select a file first', 'warning');
        return;
    }

    const formData = new FormData();
    formData.append('file', storyFile);

    try {
        const response = await fetch('/story', {
            method: 'POST',
            body: formData
        });

        const data = await response.json();

        if (data.success) {
            closeStoryPreview();
            showToast('Story uploaded successfully!', 'success');
            // Update UI to show active story if needed
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            const errorMsg = data.error || 'Error uploading story';
            const details = data.details ? `: ${data.details}` : '';
            showToast(`${errorMsg}${details}`, 'error');
        }
    } catch (error) {
        console.error('Error:', error);
        showToast('Error uploading story. Please try again.', 'error');
    }
}

// Close story preview
function closeStoryPreview() {
    document.getElementById('storyPreviewModal').classList.add('hidden');
    document.getElementById('storyUpload').value = '';
    document.getElementById('storyDeleteButtonContainer').classList.add('hidden');
    storyFile = null;
}

// Delete story
async function deleteStory() {
    // Get the current active story ID
    const storyRing = document.querySelector('.story-ring');
    if (!storyRing) {
        showToast('No active story to delete', 'warning');
        return;
    }
    
    if (!confirm('Are you sure you want to delete your story?')) {
        return;
    }
    
    try {
        const response = await fetch('/story/delete', {
            method: 'DELETE'
        });
        
        const data = await response.json();
        
        if (response.ok) {
            showToast('Story deleted successfully', 'success');
            closeStoryPreview();
            
            // Refresh the page to update UI
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            showToast(data.error || 'Failed to delete story', 'error');
        }
    } catch (error) {
        console.error('Error deleting story:', error);
        showToast('An error occurred while deleting the story', 'error');
    }
}

// Delete confirmation functionality
function showDeleteConfirmation(postId) {
    console.log('Showing delete confirmation for post:', postId);
    currentPostId = postId;
    
    // Get the modal and ensure it has the correct display properties
    const modal = document.getElementById('deleteConfirmModal');
    modal.style.display = 'flex';
    modal.classList.remove('hidden');
    
    // Prevent body scrolling when modal is open
    document.body.style.overflow = 'hidden';
}

function closeDeleteConfirmModal() {
    console.log('Closing delete confirmation modal');
    const modal = document.getElementById('deleteConfirmModal');
    modal.classList.add('hidden');
    modal.style.display = 'none';
    
    // Re-enable body scrolling
    document.body.style.overflow = '';
    currentPostId = null;
}

// Confirm delete post action
async function confirmDeletePost() {
    console.log('Confirming delete for post ID:', currentPostId);
    
    if (!currentPostId) {
        console.error('No post ID found for deletion');
        return;
    }
    
    try {
        console.log(`Sending DELETE request to /post/${currentPostId}/delete`);
        const response = await fetch(`/post/${currentPostId}/delete`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        console.log('Delete response status:', response.status);
        
        if (response.ok) {
            // Remove from DOM with animation
            const postElement = document.querySelector(`[data-post-id="${currentPostId}"]`);
            if (postElement) {
                console.log('Found post element, removing from DOM');
                postElement.classList.add('scale-0', 'opacity-0');
                setTimeout(() => {
                    postElement.remove();
                    
                    // Update post count
                    const postsCount = document.querySelector('span.block.text-base.md\\:text-lg.font-bold');
                    if (postsCount) {
                        const currentCount = parseInt(postsCount.textContent) - 1;
                        postsCount.textContent = currentCount;
                    }
                    
                    // Show empty state if no posts left
                    const postGrid = document.querySelector('.grid');
                    if (postGrid && postGrid.children.length === 0) {
                        postGrid.parentElement.innerHTML = `
                            <div class="flex flex-col items-center justify-center py-12 text-center">
                                <div class="text-5xl text-gray-300 dark:text-gray-600 mb-4">
                                    <i class="fas fa-camera"></i>
                                </div>
                                <p class="text-gray-500 dark:text-gray-400 mb-2">No posts yet</p>
                                <p class="text-sm text-gray-400 dark:text-gray-500">When you share photos, they'll appear here.</p>
                            </div>
                        `;
                    }
                }, 300);
            } else {
                console.error('Post element not found in DOM');
            }
            
            showToast('Post deleted successfully', 'success');
        } else {
            console.error('Error in delete response:', response.status);
            let errorData;
            try {
                errorData = await response.json();
                console.error('Error data:', errorData);
            } catch (e) {
                console.error('Could not parse error response as JSON');
            }
            showToast(errorData?.error || 'Failed to delete post', 'error');
        }
        closeDeleteConfirmModal();
    } catch (error) {
        console.error('Exception in delete post:', error);
        showToast('An error occurred while deleting the post', 'error');
        closeDeleteConfirmModal();
    }
}

// Event listeners for clicks outside menu
document.addEventListener('click', function(e) {
    if (e.target.closest('#postOptionsMenu')) {
        // Clicks inside the menu should be handled by their own handlers
        return;
    }
    
    // Close menu when clicking outside
    if (document.getElementById('postOptionsMenu') && !document.getElementById('postOptionsMenu').classList.contains('hidden')) {
        closePostMenu();
    }
});

// Close modals when clicking outside
window.addEventListener('click', function(event) {
    const deleteConfirmModal = document.getElementById('deleteConfirmModal');
    const storyPreviewModal = document.getElementById('storyPreviewModal');
    const createPostModal = document.getElementById('createPostModal');
    
    if (event.target === deleteConfirmModal) closeDeleteConfirmModal();
    if (event.target === storyPreviewModal) closeStoryPreview();
    if (event.target === createPostModal) closeCreatePostModal();
});

function preventDefaults(e) {
    e.preventDefault();
    e.stopPropagation();
}

function highlight() {
    dropZone.classList.add('bg-blue-50', 'dark:bg-blue-900', 'border-2', 'border-dashed', 'border-blue-300', 'dark:border-blue-700');
}

function unhighlight() {
    dropZone.classList.remove('bg-blue-50', 'dark:bg-blue-900', 'border-2', 'border-dashed', 'border-blue-300', 'dark:border-blue-700');
}

function handleDrop(e) {
    const dt = e.dataTransfer;
    const files = dt.files;
    
    // Update file input with dropped files
    if (files && files.length > 0) {
        // Unfortunately, we can't directly set FileList to an input
        // So we'll trigger the change event handler manually
        document.getElementById('imageInput').files = files;
        handleImageSelect({target: {files: files}});
    }
}

// Function to handle direct delete button click
function deletePostClicked() {
    console.log('Delete button clicked directly, current post ID:', currentPostId);
    closePostMenu();
    showDeleteConfirmation(currentPostId);
}

function showFollowers(type) {
    const userId = '<%= user._id %>';
    const modalTitle = document.getElementById('modalTitle');
    const followersList = document.getElementById('followersList');
    
    // Set modal title
    modalTitle.textContent = type === 'followers' ? 'Followers' : 'Following';
    
    // Show loading state
    followersList.innerHTML = `
        <div class="flex justify-center py-8">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-gray-800 dark:border-white"></div>
        </div>
    `;
    
    // Show the modal
    document.getElementById('followersModal').classList.remove('hidden');
    document.body.style.overflow = 'hidden'; // Prevent scrolling behind modal
    
    // Fetch data
    fetch(`/api/users/${userId}/${type}`)
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to fetch data');
            }
            return response.json();
        })
        .then(data => {
            if (!data || data.length === 0) {
                followersList.innerHTML = `
                    <div class="py-8 text-center">
                        <p class="text-gray-500 dark:text-gray-400">No ${type === 'followers' ? 'followers' : 'following'} yet</p>
                    </div>
                `;
                return;
            }
            
            // Render users
            followersList.innerHTML = '';
            data.forEach(user => {
                const userElement = document.createElement('div');
                userElement.className = 'flex items-center justify-between py-3 px-2 border-b border-gray-200 dark:border-gray-700';
                userElement.innerHTML = `
                    <div class="flex items-center">
                        <img src="${user.profileImage || '/img/default-avatar.png'}" alt="${user.username}" 
                             class="w-10 h-10 rounded-full object-cover">
                        <div class="ml-3">
                            <a href="/user/${user.username}" class="font-medium text-gray-800 dark:text-white hover:underline">${user.username}</a>
                            <p class="text-sm text-gray-500 dark:text-gray-400">${user.name || ''}</p>
                        </div>
                    </div>
                `;
                followersList.appendChild(userElement);
            });
        })
        .catch(error => {
            console.error('Error:', error);
            followersList.innerHTML = `
                <div class="py-8 text-center">
                    <p class="text-red-500">Error loading data. Please try again.</p>
                </div>
            `;
        });
}

function closeFollowersModal() {
    document.getElementById('followersModal').classList.add('hidden');
    document.body.style.overflow = ''; // Re-enable scrolling
}

// Close modals with ESC key
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        // Close any open modals
        closeCreatePostModal();
        closeFollowersModal();
        closeDeleteConfirmModal();
        closeStoryPreview();
        console.log('ESC key pressed, closing modals');
    }
});
</script>

<!-- Followers Modal - Instagram Style -->
<div id="followersModal" class="fixed inset-0 bg-black bg-opacity-75 hidden z-50 flex items-center justify-center">
    <div class="bg-white dark:bg-gray-900 rounded-lg max-w-md w-full mx-4">
        <div class="flex justify-between items-center p-4 border-b border-gray-200 dark:border-gray-700">
            <h3 id="modalTitle" class="text-lg font-semibold text-gray-800 dark:text-white">Followers</h3>
            <button onclick="closeFollowersModal()" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div id="followersList" class="max-h-96 overflow-y-auto p-2">
            <!-- Followers will be loaded here -->
            <div class="flex justify-center py-8">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-gray-800 dark:border-white"></div>
            </div>
        </div>
    </div>
</div>

</body>
</html>
